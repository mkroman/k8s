{{- range $key, $value := .Values.applications -}}
{{- $path := default $key .path }}
{{- $automatedPrune := default true .automatedPrune }}
{{- $disableAutoSync := default false .disableAutoSync }}
{{- $namespace := default $key .namespace | quote }}
{{- $selfHeal := default true .selfHeal }}
{{- $finalizer := default true .finalizer }}
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: {{ $key }}
  namespace: {{ include "apps-of-apps.argocdNamespace" $ }}
{{- if $finalizer }}
  finalizers:
  - resources-finalizer.argocd.argoproj.io
{{- end }}
spec:
  destination:
    namespace: {{ $namespace }}
    server: {{ $.Values.destination.server }}
  project: {{ $.Release.Name }}
  source:
    path: {{ default $key .path }}
    repoURL: {{ $.Values.repository }}
{{- with .source }}
    {{ toYaml . | nindent 4 }}
{{- end }}
{{- if not $disableAutoSync }}
  syncPolicy:
    automated:
      prune: {{ $automatedPrune }}
      selfHeal: {{ $selfHeal }}
    syncOptions:
    - ApplyOutOfSyncOnly=true
{{- end }}
{{- end }}
